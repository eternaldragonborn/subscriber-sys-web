  <!DOCTYPE html>

  <head>
  	<meta charset="utf-8">
  	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous">
  	<link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.19.1/dist/bootstrap-table.min.css">
  	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
  	<link rel="stylesheet" type="text/css" href="/style.css">
  	<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  	<script src="https://unpkg.com/bootstrap-table@1.19.1/dist/bootstrap-table.min.js"></script>
  	<script src="https://cdn.jsdelivr.net/gh/wenzhixin/bootstrap-table-examples@master/utils/natural-sorting/dist/natural-sorting.js"></script>
  	<title>訂閱者頁面</title>
  </head>

  <body>
  	<% include /modals/artist_modals %>
  	<!-- navbar -->
  	<div class="fliud-container">
  		<header class="d-flex justify-content-center py-3">
  			<ul class="nav nav-tabs nav-pills">
  				<li class="nav-item"><a href="/overview" class="nav-link" aria-current="page">訂閱總覽</a></li>
  				<li class="nav-item"><a href="/subscriber/<%- id %>" class="nav-link active">訂閱管理</a></li>
  			</ul>
  		</header>
  	</div>
  	<!-- end of navbar -->

  	<div class="container">
  		<!-- toolbar -->
  		<div id="toolbar">
  			<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addArtist">
  				新增繪師
  			</button>
  			<button disabled type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#delArtist">
  				退訂繪師
  			</button>
  			<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#editInfo">
  				修改資料
  			</button>
  		</div>
  		<!-- end of toolbar -->

  		<div class="alert alert-warning" role="alert">
  			<i class="fas fa-exclamation-triangle fa-lg me-2"></i>
  			欄位排序功能會使勾選方塊功能出錯，因此暫不使用。
  		</div>

  		<% if(data.subscribers.length != 0) { %>
  		<!-- artists table -->
  		<div class="table-responsive mt-3">
  			<table data-classes="table align-middle table-bordered" data-toggle="table" data-sort-reset="true" data-toolbar="#toolbar" id="subscription-table">
  				<form method="post" action="/update">
  					<thead class="table-dark">
  						<tr>
  							<th data-width="50" class="text-center">
  								<button type="submit" class="btn btn-primary" id="artist-update" disabled>更新</button>
  							</th>
  							<th data-field="artist" data-sortable="false">繪師</th>
  							<th data-field="mark">備註</th>
  							<th data-field="updateTime">上次更新</th>
  							<th data-field="status" data-sortable="false">更新狀態</th>
  						</tr>
  					</thead>
  					<tbody>
  						<% data.subscribers.forEach(subscriber=> { %>
  						<% const artists=data.artists.filter(d=> d.subscriber === subscriber.id) %>
  						<% if(artists.length != 0 ){ %>
  						<% artists.forEach((artist, index)=> { %>
  						<tr>
  							<td>
  								<input type="checkbox" name="artist" id="artist-name-<%- artist['artist'] %>" value=<%- artist['artist'] %> onclick="">
  							</td>
  							<td>
  								<%- artist['artist'] %>
  							</td>
  							<td>
  								<%- artist['mark'] %>
  							</td>
  							<td>
  								<%- artist['lastUpdateTime'].slice(0,10) %>
  							</td>
  							<td>
  								<%- artist['status'] %>
  							</td>
  						</tr>
  						<% }) %>
  						<% } %>
  						<% }) %>
  					</tbody>
  				</form>
  			</table>
  		</div>
  		<!-- end of table -->
  		<% } else { %>
  		<!-- 尚未建檔 WIP -->
  		<% /*include /modals/add_subscriber*/ %>
  		<script defer>
const myModal = document.getElementById('addSubscriber')
const modal = new bootstrap.Modal(myModal);
let result = confirm("網址資料尚未建檔，是否現在建檔？");
if (result) {
	modal.show(myModal);
} else {
	window.location.href = "/overview";
}
myModal.addEventListener('hidden.bs.modal', (event) => {
	alert("尚未建檔，無法進行操作，將返回總覽。");
	window.location.href = "/overview";
})
  		</script>
  		<% } %>
  	</div>
  	<script>
$(document)
	.ready(function() {
		var count = 0;
		$('#subscription-table tr')
			.click(function(event) {
				if (event.target.type !== 'checkbox') {
					$(':checkbox', this)
						.trigger('click');
				}
			});

		$('[name = "artist"]')
			.change((event) => {
				count += event.currentTarget.checked ? 1 : -1;
				$('#artist-update')
					.attr('disabled', count === 0);
			})
	});
  	</script>
  </body>